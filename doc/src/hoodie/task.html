<!DOCTYPE html><html lang="en"><head><title>src/hoodie/task</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/hoodie/task"><meta name="groc-project-path" content="src/hoodie/task.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/hoodie/task.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="tasks">Tasks</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This class defines the hoodie.task API.</p>

<p>The returned API provides the following methods:</p>

<ul>
<li>start</li>
<li>cancel</li>
<li>restart</li>
<li>remove</li>
<li>on</li>
<li>one</li>
<li>unbind</li>
</ul>

<p>At the same time, the returned API can be called as function returning a
store scoped by the passed type, for example</p>

<pre><code>var emailTasks = hoodie.task('email');
emailTasks.start( properties );
emailTasks.cancel('id123');
</code></pre></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">hoodieEvents</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./events&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">hoodieScopedTask</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./scoped_task&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">HoodieError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./error&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">extend</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;extend&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">hoodieTask</span><span class="p">(</span><span class="nx">hoodie</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>public API</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">api</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">hoodieScopedTask</span><span class="p">(</span><span class="nx">hoodie</span><span class="p">,</span> <span class="nx">api</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add events API</p></div></div><div class="code"><div class="wrapper">  <span class="nx">hoodieEvents</span><span class="p">(</span><span class="nx">hoodie</span><span class="p">,</span> <span class="p">{</span> <span class="nx">context</span><span class="o">:</span> <span class="nx">api</span><span class="p">,</span> <span class="nx">namespace</span><span class="o">:</span> <span class="s1">&#39;task&#39;</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="start">start</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start a new task. If the user has no account yet, hoodie tries to sign up
for an anonymous account in the background. If that fails, the returned
promise will be rejected.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hoodie</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">hasAccount</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="nx">properties</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">handleNewTask</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">anonymousSignUp</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="cancel">cancel</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>cancel a running task</p></div></div><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">cancel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">cancelledAt</span><span class="o">:</span> <span class="nx">now</span><span class="p">()</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">handleCancelledTaskObject</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="restart">restart</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>first, we try to cancel a running task. If that succeeds, we start
a new one with the same properties as the original</p></div></div><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">restart</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">extend</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">update</span><span class="p">);</span>
      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">$error</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">$processedAt</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">cancelledAt</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="cancelall">cancelAll</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">cancelAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">findAll</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">cancelTaskObjects</span> <span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="restartall">restartAll</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">restartAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">update</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">findAll</span><span class="p">(</span><span class="nx">type</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">taskObjects</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">restartTaskObjects</span><span class="p">(</span><span class="nx">taskObjects</span><span class="p">,</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>subscribe to store events
we subscribe to all store changes, pipe through the task ones,
making a few changes along the way.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">subscribeToOutsideEvents</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>account events</p></div></div><div class="code"><div class="wrapper">    <span class="nx">hoodie</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;store:change&#39;</span><span class="p">,</span> <span class="nx">handleStoreChange</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>allow to run this only once from outside (during Hoodie initialization)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">api</span><span class="p">.</span><span class="nx">subscribeToOutsideEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">subscribeToOutsideEvents</span><span class="p">();</span>
    <span class="k">delete</span> <span class="nx">api</span><span class="p">.</span><span class="nx">subscribeToOutsideEvents</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">handleNewTask</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defer</span> <span class="o">=</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">taskStore</span> <span class="o">=</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

    <span class="nx">taskStore</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove "$" from type</p></div></div><div class="code"><div class="wrapper">      <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>task finished by worker.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">$processedAt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>manually removed / cancelled.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">HoodieError</span><span class="p">({</span>
        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Task has been cancelled&#39;</span><span class="p">,</span>
        <span class="nx">task</span><span class="o">:</span> <span class="nx">object</span>
      <span class="p">}));</span>
    <span class="p">});</span>

    <span class="nx">taskStore</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">$error</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">object</span><span class="p">.</span><span class="nx">$error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove "$" from type</p></div></div><div class="code"><div class="wrapper">      <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

      <span class="k">delete</span> <span class="nx">object</span><span class="p">.</span><span class="nx">$error</span><span class="p">;</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
      <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="s1">&#39;Something went wrong&#39;</span><span class="p">;</span>

      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">HoodieError</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove errored task</p></div></div><div class="code"><div class="wrapper">      <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;$&#39;</span> <span class="o">+</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">handleCancelledTaskObject</span> <span class="p">(</span><span class="nx">taskObject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defer</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">taskObject</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span> <span class="c1">// no need to prefix with $, it&#39;s already prefixed.</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">taskObject</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">removePromise</span> <span class="o">=</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">taskObject</span><span class="p">.</span><span class="nx">_rev</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>task has not yet been synced.</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">removePromise</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">defer</span> <span class="o">=</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">hoodie</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s1">&#39;store:sync:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">id</span><span class="p">,</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
    <span class="nx">removePromise</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">();</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">handleStoreChange</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">triggerEvents</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">findAll</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">startsWith</span> <span class="o">=</span> <span class="s1">&#39;$&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">filter</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">startsWith</span> <span class="o">+=</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">startsWith</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">filter</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">cancelTaskObjects</span> <span class="p">(</span><span class="nx">taskObjects</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">taskObjects</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">taskObject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="nx">taskObject</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">taskObject</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">restartTaskObjects</span> <span class="p">(</span><span class="nx">taskObjects</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">taskObjects</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">taskObject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">restart</span><span class="p">(</span><span class="nx">taskObject</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">taskObject</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>this is where all the task events get triggered,
like add:message, change:message:abc4567, remove, etc.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">triggerEvents</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">error</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>"new" tasks are trigger as "start" events</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eventName</span> <span class="o">=</span> <span class="s1">&#39;start&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;remove&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">task</span><span class="p">.</span><span class="nx">cancelledAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eventName</span> <span class="o">=</span> <span class="s1">&#39;cancel&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;remove&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">task</span><span class="p">.</span><span class="nx">$processedAt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eventName</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">===</span> <span class="s1">&#39;update&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">task</span><span class="p">.</span><span class="nx">$error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eventName</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span><span class="p">;</span>
      <span class="nx">error</span> <span class="o">=</span> <span class="nx">task</span><span class="p">.</span><span class="nx">$error</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">task</span><span class="p">.</span><span class="nx">$error</span><span class="p">;</span>

      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">task</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;:error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

      <span class="nx">options</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">error</span><span class="o">:</span> <span class="nx">error</span>
      <span class="p">});</span>

      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:change&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">task</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;:change&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ignore all the other events</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">!==</span> <span class="s1">&#39;start&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">eventName</span> <span class="o">!==</span> <span class="s1">&#39;cancel&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">eventName</span> <span class="o">!==</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">!==</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">task</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:change&#39;</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eventName</span> <span class="o">!==</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">task</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;:change&#39;</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">now</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&#39;&quot;]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>extend hoodie</p></div></div><div class="code"><div class="wrapper">  <span class="nx">hoodie</span><span class="p">.</span><span class="nx">task</span> <span class="o">=</span> <span class="nx">api</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">hoodieTask</span><span class="p">;</span></div></div></div></div></body></html>